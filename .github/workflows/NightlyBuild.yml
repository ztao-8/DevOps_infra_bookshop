name: Nightly Deployment

on:
  schedule:
    - cron: "0 2 * * *"  # ÊØèÂ§©ÂáåÊô® 2 ÁÇπÊâßË°å
  workflow_dispatch:  # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_BACKEND: "bookshop-backend"
  ECR_FRONTEND: "bookshop-frontend"
  ECR_REGISTRY: "509585101616.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com"

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          repository: ztao-8/DevOps_bookshop
          path: bookshop_source

      - name: Login to AWS ECR
        run: |
          aws ecr get-login-password --region $AWS_REGION | \
          docker login --username AWS --password-stdin $ECR_REGISTRY

      - name: Build and Push Docker Images using Docker Compose
        run: |
          cd bookshop_source  # ‚úÖ Navigate into the source repository directory
          docker compose build
          TIMESTAMP=$(date "+%Y%m%d.%H%M%S")
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV

          # Backend
          docker tag backend_service:latest $ECR_REGISTRY/$ECR_BACKEND:latest
          docker tag backend_service:latest $ECR_REGISTRY/$ECR_BACKEND:$TIMESTAMP
          docker push $ECR_REGISTRY/$ECR_BACKEND:latest
          docker push $ECR_REGISTRY/$ECR_BACKEND:$TIMESTAMP

          # Frontend
          docker tag frontend_service:latest $ECR_REGISTRY/$ECR_FRONTEND:latest
          docker tag frontend_service:latest $ECR_REGISTRY/$ECR_FRONTEND:$TIMESTAMP
          docker push $ECR_REGISTRY/$ECR_FRONTEND:latest
          docker push $ECR_REGISTRY/$ECR_FRONTEND:$TIMESTAMP


  setup-test-ec2:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Launch Temporary EC2
        run: |
          TEMP_INSTANCE_ID=$(aws ec2 run-instances \
            --region $AWS_REGION \
            --image-id ami-04b4f1a9cf54c11d0 \
            --instance-type t2.micro \
            --key-name book-key \
            --security-group-ids sg-03ca7c5be577e6761 \
            --query 'Instances[0].InstanceId' \
            --output text)

          echo "‚úÖ EC2 Instance ID: $TEMP_INSTANCE_ID"
          echo "$TEMP_INSTANCE_ID" > instance_id.txt
          echo "INSTANCE_ID=$TEMP_INSTANCE_ID" >> $GITHUB_ENV  # Store for later steps

          aws ec2 wait instance-running --region $AWS_REGION --instance-ids $TEMP_INSTANCE_ID

          TEMP_IP=$(aws ec2 describe-instances \
            --region $AWS_REGION \
            --instance-ids $TEMP_INSTANCE_ID \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)

          if [ -z "$TEMP_IP" ]; then
            echo "‚ùå EC2 failed to start"
            exit 1
          fi
          
          echo "‚úÖ EC2 Public IP: $TEMP_IP"
          echo "$TEMP_IP" > temp_ip.txt

      - name: Save TEMP_IP
        uses: actions/upload-artifact@v4
        with:
          name: ec2-ip
          path: temp_ip.txt

      - name: Upload INSTANCE_ID as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ec2-instance-id
          path: instance_id.txt


  deploy-source-to-ec2:
    needs: setup-test-ec2
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Infra Repository
        uses: actions/checkout@v4

      - name: Get TEMP_IP
        uses: actions/download-artifact@v4
        with:
          name: ec2-ip

      - name: Read TEMP_IP
        run: |
          TEMP_IP=$(cat temp_ip.txt)
          echo "‚úÖ TEMP_IP: $TEMP_IP"
          echo "TEMP_IP=$TEMP_IP" >> $GITHUB_ENV

      - name: Set up SSH Key
        run: |
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > book-key.pem
          chmod 400 book-key.pem

      - name: Wait for EC2
        run: sleep 240

      - name: Install AWS CLI in EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i book-key.pem ubuntu@${{ env.TEMP_IP }} << EOF
            sudo apt update -y
            sudo apt install -y awscli
          EOF

      - name: Deploy Using Docker Compose
        run: |
          ssh -o StrictHostKeyChecking=no -i book-key.pem ubuntu@${{ env.TEMP_IP }} << EOF
            echo "üîÑ Updating system..."
            sudo apt update -y && sudo apt upgrade -y

            echo "üîß Installing Docker..."
            sudo apt install -y git docker.io docker-compose
            sudo systemctl start docker
            sudo systemctl enable docker

            echo "üê≥ Logging in to AWS ECR..."
            aws ecr get-login-password --region $AWS_REGION | sudo docker login --username AWS --password-stdin $ECR_REGISTRY

            
            echo "üìÇ Cloning Source Code Repo..."
            if [ ! -d "bookshop_source" ]; then
              git clone https://github.com/ztao-8/DevOps_bookshop.git bookshop_source
            else
              cd bookshop_source && git pull && cd ..
            fi

            cd bookshop_source || exit 1  # ‚úÖ Ensure we are in the correct directory

            if [ ! -f docker-compose.yml ]; then
              echo "‚ùå docker-compose.yml not found! Exiting..."
              exit 1
            fi

            echo "üìù Updating docker-compose.yml..."
            sed -i 's|image: backend_service|image: $ECR_REGISTRY/$ECR_BACKEND:latest|' docker-compose.yml
            sed -i 's|image: frontend_service|image: $ECR_REGISTRY/$ECR_FRONTEND:latest|' docker-compose.yml

            echo "üöÄ Running Docker Compose..."
            sudo docker-compose down  # Stop old containers
            sudo docker-compose up -d  # Start new containers
          EOF

      - name: Copy Smoke Test Script to EC2
        run: |
          scp -o StrictHostKeyChecking=no -i book-key.pem scripts/smoke-test.sh ubuntu@${{ env.TEMP_IP }}:/home/ubuntu/smoke-test.sh

      - name: Run Smoke Test on EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i book-key.pem ubuntu@${{ env.TEMP_IP }} << EOF
            sleep 20
            chmod +x /home/ubuntu/smoke-test.sh
            /home/ubuntu/smoke-test.sh localhost
          EOF

      - name: Remove Images if Test Fails
        if: failure()
        run: |
          echo "‚ùå Smoke Test Failed! Removing ECR images..."
          BACKEND_TAGS=$(aws ecr list-images --repository-name bookshop-backend --query 'imageIds[*].imageTag' --output text | grep -E '^[0-9]{8}\.[0-9]{6}$' | sort -r)
          FRONTEND_TAGS=$(aws ecr list-images --repository-name bookshop-frontend --query 'imageIds[*].imageTag' --output text | grep -E '^[0-9]{8}\.[0-9]{6}$' | sort -r)

          LATEST_BACKEND_TAG=$(echo "$BACKEND_TAGS" | head -n 1)
          LATEST_FRONTEND_TAG=$(echo "$FRONTEND_TAGS" | head -n 1)

          [ -n "$LATEST_BACKEND_TAG" ] && aws ecr batch-delete-image --repository-name bookshop-backend --image-ids imageTag=$LATEST_BACKEND_TAG || true
          [ -n "$LATEST_FRONTEND_TAG" ] && aws ecr batch-delete-image --repository-name bookshop-frontend --image-ids imageTag=$LATEST_FRONTEND_TAG || true

          echo "‚úÖ Cleanup completed."

      - name: Get INSTANCE_ID
        uses: actions/download-artifact@v4
        with:
          name: ec2-instance-id

      - name: Read INSTANCE_ID
        run: |
          INSTANCE_ID=$(cat instance_id.txt)
          if [ -z "$INSTANCE_ID" ]; then
            echo "‚ùå ERROR: INSTANCE_ID is empty. Exiting..."
            exit 1
          fi
          echo "‚úÖ INSTANCE_ID: $INSTANCE_ID"
          echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_ENV


      - name: Terminate Temporary EC2 Instance
        run: |
          INSTANCE_ID=${{ env.INSTANCE_ID }}
          if [ -z "$INSTANCE_ID" ]; then
            echo "‚ùå ERROR: No instance ID found. Skipping termination."
            exit 1
          fi
          echo "üîÑ Terminating EC2 instance: $INSTANCE_ID"
          aws ec2 terminate-instances --instance-ids $INSTANCE_ID
