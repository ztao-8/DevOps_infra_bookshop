name: Nightly Deployment

on:
  schedule:
    - cron: "0 2 * * *"  # 每天凌晨 2 点自动执行
  workflow_dispatch:  # 允许手动触发

jobs:
  setup-test-ec2:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        run: |
          export AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          export AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          export AWS_SESSION_TOKEN=${{ secrets.AWS_SESSION_TOKEN }}
          export AWS_REGION=${{ secrets.AWS_REGION }}

      - name: run temp EC2
        run: |
          TEMP_INSTANCE_ID=$(aws ec2 run-instances \
            --region us-east-1 \
            --image-id ami-014d544cfef21b42d \
            --instance-type t2.micro \
            --key-name my-key \
            --security-groups rds-access-sg \
            --query 'Instances[0].InstanceId' \
            --output text)

          echo "TEMP_INSTANCE_ID=$TEMP_INSTANCE_ID" >> $GITHUB_ENV
          aws ec2 wait instance-running --instance-ids $TEMP_INSTANCE_ID

          TEMP_IP=$(aws ec2 describe-instances \
            --instance-ids $TEMP_INSTANCE_ID \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          echo "TEMP_IP=$TEMP_IP" >> $GITHUB_ENV

  deploy-source-to-ec2:
    needs: setup-test-ec2
    runs-on: ubuntu-latest
    steps:
      - name: get Source Repo
        run: |
          ssh -o StrictHostKeyChecking=no -i my-key.pem ec2-user@${{ env.TEMP_IP }} << 'EOF'
            sudo yum update -y
            sudo yum install -y git docker
            sudo service docker start
            git clone https://github.com/ztao-8/DevOps_bookshop.git source-code
            cd source-code
            docker-compose up -d
          EOF

  smoke-test:
    needs: deploy-source-to-ec2
    runs-on: ubuntu-latest
    steps:
      - name: 运行 Smoke Test
        run: |
          chmod +x scripts/smoke-test.sh
          ./scripts/smoke-test.sh ${{ env.TEMP_IP }}

  build-and-push:
    needs: smoke-test
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        run: |
          export AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          export AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          export AWS_SESSION_TOKEN=${{ secrets.AWS_SESSION_TOKEN }}
          export AWS_REGION=${{ secrets.AWS_REGION }}

      - name: Login AWS ECR
        run: |
          aws ecr get-login-password --region $AWS_REGION | \
          docker login --username AWS --password-stdin 509585101616.dkr.ecr.$AWS_REGION.amazonaws.com  

      - name: Build & Push Docker Image
        run: |
          docker build -t ${{ secrets.ECR_REPOSITORY }}:latest ./backend
          docker tag ${{ secrets.ECR_REPOSITORY }}:latest 509585101616.dkr.ecr.$AWS_REGION.amazonaws.com/${{ secrets.ECR_REPOSITORY }}:latest
          docker push 509585101616.dkr.ecr.$AWS_REGION.amazonaws.com/${{ secrets.ECR_REPOSITORY }}:latest

#  deploy-to-qa:
#    needs: build-and-push
#    runs-on: ubuntu-latest
#    steps:
#      - name: 设置 SSH Key
#        run: |
#          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > my-key.pem
#          chmod 400 my-key.pem
#
#      - name: 部署到 QA 服务器
#        run: |
#          ssh -o StrictHostKeyChecking=no -i my-key.pem ec2-user@${{ secrets.QA_EC2_IP }} << 'EOF'
#            docker pull 509585101616.dkr.ecr.$AWS_REGION.amazonaws.com/${{ secrets.ECR_REPOSITORY }}:latest
#            docker stop backend_container || true
#            docker rm backend_container || true
#            docker run -d --name backend_container -p 8800:8800 509585101616.dkr.ecr.$AWS_REGION.amazonaws.com/${{ secrets.ECR_REPOSITORY }}:latest
#          EOF
